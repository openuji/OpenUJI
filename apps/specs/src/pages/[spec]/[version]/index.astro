---
import SpecTemplate from "@/templates/spec/Spec.astro";
import { renderSpecFromFile, loadJson } from "@/lib/speculator";
import { listSpecs } from "@/lib/spec-index";

export async function getStaticPaths() {
  // Add more products here if needed (or discover them similarly)
  const specs = await listSpecs();
  return specs.map(({ spec, version, indexPath, respecPath }) => ({
    params: { spec, version },
    props: { indexPath, respecPath, spec, version }
  }));
}

const { indexPath, spec, respecPath, version } = Astro.props;

let specData: { sections: string; warnings?: string[], toc: string } = { sections: '', toc: '' };
let metaData: Record<string, any> = {};
try {
  specData = await renderSpecFromFile(indexPath);
  if (respecPath) {
    const respecMeta = await loadJson(respecPath);
    metaData = respecMeta || {};
  }

  if (specData.warnings?.length) {
    console.warn(`[Speculator] ${spec}@${version}`, specData.warnings);
  }

} catch (err) {
  console.error(`[Speculator] Error rendering ${spec}@${version}`, err);
  Astro.response.status = 404;
  specData.sections = `<article><h1>Spec not found</h1><p>Missing: ${indexPath}</p></article>`;
}
---

<SpecTemplate title={`${spec.toUpperCase()} ${version}`} sections={specData.sections} toc={specData.toc} metaData={metaData} />
